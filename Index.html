<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre das Escalas Musicais</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .nota-teclado {
            width: 60px;
            height: 60px;
            margin: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
        }
        .nota-teclado.sustenido {
            background-color: black !important;
            color: white !important;
        }
        .nota-escala {
            width: 70px;
            height: 70px;
            margin: 5px;
            border: 2px solid #343a40;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
        }
        .nota-preenchida {
            background-color: #28a745 !important;
            color: white;
            border-color: #1e7e34;
        }
        .nota-errada {
            animation: shake 0.5s;
            background-color: #dc3545 !important;
            color: white;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .intervalos-container {
            display: flex;
            justify-content: center;
            margin-top: 8px;
            gap: 10px;
        }
        .intervalo-box {
            font-size: 0.9rem;
            font-weight: bold;
            color: #444;
        }
    </style>
</head>
<body>

    <!-- Modal de Boas-Vindas -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="welcomeModalLabel">Seja Bem Vindo ao jogo Mestre das Escalas üé∂</h5>
                </div>
                <div class="modal-body text-center">
                    <p class="fs-4 fw-bold text-dark">
                        Prepare seus ouvidos e sua mente! Chegou a hora de desvendar os segredos da harmonia e dominar a constru√ß√£o das escalas musicais!
                    </p>
                    <p class="text-muted">
                        Complete 10 desafios de escalas maiores para provar sua maestria. Boa sorte!
                    </p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success btn-lg" data-bs-dismiss="modal">
                        Come√ßar a Jogar!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="container mt-5">
        <h1 class="text-center mb-4">Mestre das Escalas</h1>

        <div id="modo-selecao" class="text-center">
            <h3 class="mb-3">Escolha o Modo:</h3>
            <div class="d-flex justify-content-center flex-wrap">
                <button class="btn btn-primary btn-lg m-2" onclick="iniciarJogo('major')">
                    Escalas Maiores
                </button>
                <div class="dropdown m-2">
                    <button class="btn btn-warning btn-lg dropdown-toggle" type="button" disabled>
                        Escalas Menores (Desabilitado)
                    </button>
                </div>
            </div>
            <p class="mt-3 text-danger fw-bold">Modo de Escalas Menores desabilitado conforme as regras do desafio.</p>
        </div>
        
        <!-- Relat√≥rio Final -->
        <div id="area-relatorio" class="mt-5 p-4 border rounded shadow-sm d-none">
            <h2 class="text-center text-success mb-4">Relat√≥rio Final do Desafio</h2>
            <div id="relatorio-detalhes" class="fs-4 text-center"></div>
            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg" onclick="location.reload()">Recome√ßar o Jogo</button>
            </div>
        </div>

        <!-- √Årea do Jogo -->
        <div id="area-jogo" class="mt-5 p-4 border rounded shadow-sm d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button class="btn btn-secondary btn-sm" onclick="location.reload()">
                    &larr; Voltar ao In√≠cio / Recome√ßar
                </button>
				</br>
                
                <h3 id="desafio-titulo" class="m-0 flex-grow-1 text-center"></h3>
				<span class="badge bg-dark fs-5">Desafio <span id="contador-desafios">1</span> de 10</span>
            </div>
            
            <div id="escala-container" class="d-flex justify-content-center flex-column align-items-center mb-4"></div>

            <div class="alert alert-info text-center" id="feedback-mensagem" role="alert">
                Clique nas notas abaixo para construir a escala.
            </div>

            <div id="teclado-container" class="d-flex justify-content-center flex-wrap"></div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg d-none m-2" id="botao-tocar-escala" onclick="tocarEscalaCompleta()">Tocar Escala Formada üé∂</button>
                <button class="btn btn-success btn-lg d-none m-2" id="botao-proximo" onclick="proximoDesafio()">Pr√≥xima Escala</button>
            </div>
        </div>
    </div>

    <!-- Depend√™ncias -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>

    <script>
        // --- DADOS MUSICAIS ---
        const notasCromaticas = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const padraoEscala = {
            major: { 
                nome: "Maior", 
                intervalos: [0, 2, 4, 5, 7, 9, 11, 12] 
            }
        };
        const intervalosDescricao = ["Tom", "Tom", "Semitom", "Tom", "Tom", "Tom", "Semitom"];

        // --- VARI√ÅVEIS ---
        const MAX_DESAFIOS = 10;
        const MAX_ERROS_PARA_PASSAR = 7; 
        
        let modoAtual = 'major';
        let escalaCorreta = [];
        let notaAtualIndex = 0;
        let notasComErroNesteDesafio = new Set();
        let desafiosCompletados = 0;
        let totalErros = 0;
        let jogoFinalizado = false;
        let synth;

        function inicializarAudio() {
            if (!synth) {
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sawtooth" },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
                }).toDestination();
                Tone.start();
            }
        }

        function tocarNota(nota) {
            const notaComOitava = nota + "4"; 
            if (synth) {
                synth.triggerAttackRelease(notaComOitava, "0.4s");
            }
        }

        function tocarEscalaCompleta() {
            if (!synth) return; 
            const notasComOitava = escalaCorreta.map(nota => nota + "4");
            notasComOitava.forEach((nota, index) => {
                Tone.Transport.scheduleOnce(time => {
                    synth.triggerAttackRelease(nota, "0.4", time);
                }, index * 0.5);
            });
            Tone.Transport.start(); 
            setTimeout(() => Tone.Transport.stop(), notasComOitava.length * 500);
        }

        function gerarEscalaCorreta(tonicaIndex, modo) {
            const intervalos = padraoEscala[modo].intervalos;
            return intervalos.map(int => notasCromaticas[(tonicaIndex + int) % 12]);
        }

        function renderizarTeclado() {
            const tecladoDiv = document.getElementById('teclado-container');
            tecladoDiv.innerHTML = ''; 
            notasCromaticas.forEach(nota => {
                const button = document.createElement('button');
                button.className = 'btn nota-teclado';
                if (nota.includes("#")) {
                    button.classList.add("sustenido");
                } else {
                    button.classList.add("btn-secondary");
                }
                button.textContent = nota;
                button.setAttribute('onclick', `checarNota('${nota}')`);
                tecladoDiv.appendChild(button);
            });
        }

        function renderizarEscalaContainer() {
            const escalaDiv = document.getElementById('escala-container');
            escalaDiv.innerHTML = ''; 

            const linhaNotas = document.createElement('div');
            linhaNotas.className = "d-flex justify-content-center";
            for (let i = 0; i < 8; i++) {
                const notaBox = document.createElement('div');
                notaBox.className = 'nota-escala';
                notaBox.id = `nota-box-${i}`;
                if (i === 0) {
                    notaBox.textContent = escalaCorreta[0];
                    notaBox.classList.add('nota-preenchida');
                } else {
                    notaBox.textContent = '?';
                }
                linhaNotas.appendChild(notaBox);
            }
            escalaDiv.appendChild(linhaNotas);

            // Linha dos intervalos
            const linhaIntervalos = document.createElement('div');
            linhaIntervalos.className = 'intervalos-container';
            intervalosDescricao.forEach(intervalo => {
                const box = document.createElement('div');
                box.className = 'intervalo-box';
                box.textContent = intervalo;
                linhaIntervalos.appendChild(box);
            });
            escalaDiv.appendChild(linhaIntervalos);
        }

        // --- RESTANTE DO C√ìDIGO (checarNota, iniciarJogo, etc) continua igual ---
        // (mantive para n√£o ficar duplicado, j√° que a l√≥gica principal n√£o muda)

        function atualizarFeedback(mensagem, tipo = 'info') {
            const feedback = document.getElementById('feedback-mensagem');
            feedback.className = `alert alert-${tipo} text-center`;
            feedback.textContent = mensagem;
        }

        function checarVitoria() {
            if (notaAtualIndex === 8) {
                desafiosCompletados++;
                document.getElementById('contador-desafios').textContent = desafiosCompletados;
                atualizarFeedback(`üèÜ Desafio ${desafiosCompletados} conclu√≠do! Erros acumulados: ${totalErros}`, 'success');
                document.getElementById('botao-tocar-escala').classList.remove('d-none'); 
                document.querySelectorAll('.nota-teclado').forEach(btn => btn.setAttribute('disabled', 'true'));
                tocarEscalaCompleta(); 
                if (desafiosCompletados >= MAX_DESAFIOS) {
                    setTimeout(exibirRelatorioFinal, 2000); 
                } else {
                    document.getElementById('botao-proximo').classList.remove('d-none');
                }
            }
        }

        function iniciarJogo(modo) {
            inicializarAudio();
            if (modo !== 'major') return; 
            modoAtual = 'major';
            document.getElementById('modo-selecao').classList.add('d-none');
            document.getElementById('area-jogo').classList.remove('d-none');
            renderizarTeclado(); 
            gerarDesafio();
        }

        function gerarDesafio() {
            notasComErroNesteDesafio.clear();
            const tonicaIndex = Math.floor(Math.random() * 12);
            const tonicaNome = notasCromaticas[tonicaIndex];
            escalaCorreta = gerarEscalaCorreta(tonicaIndex, modoAtual);
            notaAtualIndex = 1; 
            document.getElementById('desafio-titulo').textContent = `Monte a Escala de ${tonicaNome} ${padraoEscala[modoAtual].nome}`;
            document.getElementById('botao-proximo').classList.add('d-none');
            document.getElementById('botao-tocar-escala').classList.add('d-none');
            document.querySelectorAll('.nota-teclado').forEach(btn => btn.removeAttribute('disabled'));
            document.getElementById('contador-desafios').textContent = desafiosCompletados + 1;
            renderizarEscalaContainer();
            atualizarFeedback(`Escolha a ${notaAtualIndex + 1}¬™ nota da escala. Erros acumulados: ${totalErros}`);
        }

        function checarNota(notaClicada) {
            if (notaAtualIndex >= 8 || jogoFinalizado) return; 
            tocarNota(notaClicada); 
            const notaEsperada = escalaCorreta[notaAtualIndex];
            const notaBox = document.getElementById(`nota-box-${notaAtualIndex}`);
            const indiceNota = notaAtualIndex; 
            if (notaClicada === notaEsperada) {
                notaBox.textContent = notaClicada;
                notaBox.classList.remove('nota-errada');
                notaBox.classList.add('nota-preenchida');
                notaAtualIndex++;
                checarVitoria();
                if (notaAtualIndex < 8) {
                    atualizarFeedback(`Correto! Escolha a ${notaAtualIndex + 1}¬™ nota. Erros acumulados: ${totalErros}`);
                }
            } else {
                if (!notasComErroNesteDesafio.has(indiceNota)) {
                    totalErros++;
                    notasComErroNesteDesafio.add(indiceNota);
                }
                notaBox.classList.add('nota-errada');
                atualizarFeedback(`Ops! A nota ${notaClicada} est√° errada. Erros acumulados: ${totalErros}. Tente novamente!`, 'danger');
                setTimeout(() => {
                    notaBox.classList.remove('nota-errada');
                    atualizarFeedback(`Escolha a ${notaAtualIndex + 1}¬™ nota da escala. Erros acumulados: ${totalErros}`);
                }, 500);
            }
        }

        function exibirRelatorioFinal() {
            jogoFinalizado = true;
            document.getElementById('area-jogo').classList.add('d-none');
            document.getElementById('area-relatorio').classList.remove('d-none');
            const relatorioDiv = document.getElementById('relatorio-detalhes');
            const totalNotas = MAX_DESAFIOS * 7;
            const acertosTotal = totalNotas - totalErros;
            const taxaAcerto = ((acertosTotal / totalNotas) * 100).toFixed(1);
            let mensagem = ``;
            if (totalErros < MAX_ERROS_PARA_PASSAR) {
                mensagem = `
                    <p class="text-danger fw-bold">‚ö†Ô∏è Necess√°ria Repeti√ß√£o ‚ö†Ô∏è</p>
                    <p>Voc√™ completou 10 desafios com um total de ${totalErros} erros.</p>
                    <p>Taxa de Acerto: ${taxaAcerto}%</p>
                    <p class="mt-4">Seu total de erros √© menor que 7. O desafio ser√° reiniciado para garantir a maestria!</p>
                `;
                setTimeout(reiniciarCicloDesafios, 6000); 
            } else {
                mensagem = `
                    <p class="text-success fw-bold">üéâ Parab√©ns, Mestre das Escalas! üéâ</p>
                    <p>Voc√™ completou 10 desafios com um total de ${totalErros} erros.</p>
                    <p>Taxa de Acerto: ${taxaAcerto}%</p>
                    <p class="mt-4">Clique em "Recome√ßar o Jogo" para um novo desafio.</p>
                `;
            }
            relatorioDiv.innerHTML = mensagem;
        }

        function reiniciarCicloDesafios() {
            desafiosCompletados = 0;
            totalErros = 0;
            jogoFinalizado = false;
            document.getElementById('area-relatorio').classList.add('d-none');
            document.getElementById('area-jogo').classList.remove('d-none');
            gerarDesafio();
            atualizarFeedback(`Iniciando novo ciclo de 10 desafios! Erros zerados: ${totalErros}`);
        }

        function proximoDesafio() {
            if (desafiosCompletados < MAX_DESAFIOS) {
                gerarDesafio();
            } else {
                exibirRelatorioFinal();
            }
        }

        function showWelcomeModal() {
             const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
             welcomeModal.show();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('area-relatorio').classList.add('d-none');
            showWelcomeModal();
        });
    </script>
</body>
</html>

