<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre das Escalas Musicais</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Estilos personalizados para o jogo */
        body {
            background-color: #f8f9fa; /* Fundo mais suave */
        }

        /* Estilizando as notas do teclado */
        .nota-teclado {
            /* Usando Bootstrap para bot√µes pequenos e margens */
            width: 60px;
            height: 60px;
            margin: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
        }

        /* Estilizando o espa√ßo das notas da escala montada */
        .nota-escala {
            width: 70px;
            height: 70px;
            margin: 5px;
            border: 2px solid #343a40; /* Borda escura */
            background-color: #e9ecef; /* Cor de fundo padr√£o */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
        }

        /* Estilo para notas j√° preenchidas (cor de sucesso) */
        .nota-preenchida {
            background-color: #28a745 !important; /* Verde do Bootstrap */
            color: white;
            border-color: #1e7e34;
        }

        /* Estilo para o estado de erro */
        .nota-errada {
            animation: shake 0.5s;
            background-color: #dc3545 !important; /* Vermelho do Bootstrap */
            color: white;
        }

        /* Anima√ß√£o para feedback de erro */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <h1 class="text-center mb-4">Mestre das Escalas</h1>

        <div id="modo-selecao" class="text-center">
            <h3 class="mb-4">Desafio: 10 Escalas Maiores</h3>
            <p>Seu objetivo √© completar **10 desafios** de escalas Maiores.</p>
            <p>Se voc√™ acumular **menos de 7 erros** (erro √© contado apenas na primeira tentativa incorreta por nota) ap√≥s os 10 desafios, voc√™ dever√° repetir o ciclo!</p>
            
            <hr class="my-4">
            
            <button id="ativar-audio-btn" class="btn btn-primary btn-lg m-2" onclick="ativarAudioEIniciar()">
                INICIAR DESAFIO E ATIVAR √ÅUDIO
            </button>
        </div>
        
        <div id="area-relatorio" class="mt-5 p-4 border rounded shadow-sm d-none">
            <h2 class="text-center text-success mb-4">Relat√≥rio Final do Desafio</h2>
            <div id="relatorio-detalhes" class="fs-4 text-center"></div>
            <div class="text-center mt-4">
                 <button class="btn btn-primary btn-lg" onclick="location.reload()">Recome√ßar o Jogo</button>
            </div>
        </div>

        <div id="area-jogo" class="mt-5 p-4 border rounded shadow-sm d-none">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button class="btn btn-secondary btn-sm" onclick="location.reload()">
                    &larr; Voltar ao In√≠cio / Recome√ßar
                </button>
                <span class="badge bg-dark fs-5">Desafio <span id="contador-desafios">1</span> de 10</span>
                <h3 id="desafio-titulo" class="m-0 flex-grow-1 text-center"></h3>
            </div>
            
            <div id="escala-container" class="d-flex justify-content-center mb-4">
            </div>

            <div class="alert alert-info text-center" id="feedback-mensagem" role="alert">
                Clique nas notas abaixo para construir a escala.
            </div>

            <div id="teclado-container" class="d-flex justify-content-center flex-wrap">
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg d-none m-2" id="botao-tocar-escala" onclick="tocarEscalaCompleta()">Tocar Escala Formada üé∂</button>
                <button class="btn btn-success btn-lg d-none m-2" id="botao-proximo" onclick="proximoDesafio()">Pr√≥xima Escala</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    
    <script>
        // --- DADOS MUSICAIS CENTRAIS ---
        const notasCromaticas = [
            "C", "C#", "D", "D#", "E", "F",
            "F#", "G", "G#", "A", "A#", "B"
        ];
        
        const padraoEscala = {
            major: { 
                nome: "Maior", 
                intervalos: [0, 2, 4, 5, 7, 9, 11] 
            }
        };

        // --- VARI√ÅVEIS DE ESTADO E CONTAGEM ---
        const MAX_DESAFIOS = 10;
        const MAX_ERROS_PARA_REPETIR = 7; // Erros < 7 = Repete | Erros >= 7 = Passou/Finaliza
        
        let modoAtual = 'major';
        let escalaCorreta = [];
        let notaAtualIndex = 0; 
        let notasComErroNesteDesafio = new Set(); 

        let desafiosCompletados = 0;
        let totalErros = 0;

        let jogoFinalizado = false;

        // --- VARI√ÅVEIS DE √ÅUDIO (TONE.JS) ---
        let synth = null;

        // NOVO: Fun√ß√£o que ativa o √°udio E INICIA O JOGO imediatamente
        async function ativarAudioEIniciar() {
            // 1. Ativa o contexto de √°udio
            if (Tone.context.state !== 'running') {
                try {
                    await Tone.start();
                } catch (e) {
                    console.error("Falha ao iniciar o contexto de √°udio:", e);
                    alert("O √°udio n√£o p√¥de ser ativado. Verifique as permiss√µes do navegador.");
                    return;
                }
            }
            
            // 2. Cria o sintetizador se ainda n√£o foi criado
            if (!synth) {
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sawtooth" },
                    envelope: {
                        attack: 0.005,
                        decay: 0.1,
                        sustain: 0.3,
                        release: 1 
                    }
                }).toDestination();
            }

            // 3. Inicia o jogo de Escalas Maiores
            iniciarJogo('major');
        }

        function tocarNota(nota) {
            if (!synth || Tone.context.state !== 'running') {
                console.warn("√Åudio n√£o est√° pronto.");
                return;
            }
            const notaComOitava = nota + "4"; 
            synth.triggerAttackRelease(notaComOitava, "0.4s");
        }
        
        function tocarEscalaCompleta() {
            if (!synth || Tone.context.state !== 'running') return;
            
            const notasComOitava = escalaCorreta.map(nota => nota + "4");
            
            // Usa o Tone.Sequence para reprodu√ß√£o sequencial (mais limpo que o Transport.scheduleOnce)
            const notesSequence = new Tone.Sequence((time, note) => {
                synth.triggerAttackRelease(note, "0.4", time);
            }, notasComOitava, "0.5"); 
            
            // Garante que o Transport pare ao final
            Tone.Transport.scheduleOnce(() => {
                notesSequence.dispose();
                Tone.Transport.stop();
            }, `+${notasComOitava.length * 0.5}`); 

            notesSequence.start(0);
            Tone.Transport.start(); 
        }
        
        // --- FUN√á√ïES DE L√ìGICA MUSICAL E CONTROLE DO JOGO ---

        function gerarEscalaCorreta(tonicaIndex, modo) {
            const intervalos = padraoEscala[modo].intervalos;
            const escala = [];
            
            for (const intervalo of intervalos) {
                const indiceNota = (tonicaIndex + intervalo) % 12;
                escala.push(notasCromaticas[indiceNota]);
            }
            
            return escala;
        }

        function renderizarTeclado() {
            const tecladoDiv = document.getElementById('teclado-container');
            tecladoDiv.innerHTML = ''; 

            notasCromaticas.forEach(nota => {
                const button = document.createElement('button');
                button.className = 'btn btn-secondary nota-teclado';
                button.textContent = nota;
                button.setAttribute('onclick', `checarNota('${nota}')`);
                tecladoDiv.appendChild(button);
            });
        }

        function renderizarEscalaContainer() {
            const escalaDiv = document.getElementById('escala-container');
            escalaDiv.innerHTML = ''; 

            for (let i = 0; i < 7; i++) {
                const notaBox = document.createElement('div');
                notaBox.className = 'nota-escala';
                notaBox.id = `nota-box-${i}`;
                
                if (i === 0) {
                    notaBox.textContent = escalaCorreta[0];
                    notaBox.classList.add('nota-preenchida');
                } else {
                    notaBox.textContent = '?';
                }

                escalaDiv.appendChild(notaBox);
            }
        }

        function atualizarFeedback(mensagem, tipo = 'info') {
            const feedback = document.getElementById('feedback-mensagem');
            feedback.className = `alert alert-${tipo} text-center`;
            feedback.textContent = mensagem;
        }

        function checarVitoria() {
            if (notaAtualIndex === 7) {
                desafiosCompletados++;
                
                document.getElementById('contador-desafios').textContent = desafiosCompletados;
                
                atualizarFeedback(`üèÜ Desafio ${desafiosCompletados} conclu√≠do! Erros acumulados: ${totalErros}`, 'success');
                
                document.getElementById('botao-tocar-escala').classList.remove('d-none'); 
                document.querySelectorAll('.nota-teclado').forEach(btn => btn.setAttribute('disabled', 'true'));
                
                tocarEscalaCompleta(); 

                if (desafiosCompletados >= MAX_DESAFIOS) {
                    setTimeout(exibirRelatorioFinal, 2000); 
                } else {
                    document.getElementById('botao-proximo').classList.remove('d-none');
                }
            }
        }

        function iniciarJogo(modo) {
            // For√ßa 'major' conforme a regra
            modoAtual = 'major';
            
            document.getElementById('modo-selecao').classList.add('d-none');
            document.getElementById('area-jogo').classList.remove('d-none');
            
            renderizarTeclado(); 
            gerarDesafio();
        }

        function gerarDesafio() {
            notasComErroNesteDesafio.clear();
            
            const tonicaIndex = Math.floor(Math.random() * 12);
            const tonicaNome = notasCromaticas[tonicaIndex];

            escalaCorreta = gerarEscalaCorreta(tonicaIndex, modoAtual);
            notaAtualIndex = 1; 
            
            const modoNome = padraoEscala[modoAtual].nome;
            document.getElementById('desafio-titulo').textContent = `Monte a Escala de ${tonicaNome} ${modoNome}`;
            
            document.getElementById('botao-proximo').classList.add('d-none');
            document.getElementById('botao-tocar-escala').classList.add('d-none');
            
            document.querySelectorAll('.nota-teclado').forEach(btn => btn.removeAttribute('disabled'));
            
            document.getElementById('contador-desafios').textContent = desafiosCompletados + 1;

            renderizarEscalaContainer();
            atualizarFeedback(`Escolha a ${notaAtualIndex + 1}¬™ nota da escala. Erros acumulados: ${totalErros}`);
        }

        function checarNota(notaClicada) {
            if (notaAtualIndex >= 7 || jogoFinalizado) return; 
            
            tocarNota(notaClicada); 

            const notaEsperada = escalaCorreta[notaAtualIndex];
            const notaBox = document.getElementById(`nota-box-${notaAtualIndex}`);
            const indiceNota = notaAtualIndex; 

            if (notaClicada === notaEsperada) {
                notaBox.textContent = notaClicada;
                notaBox.classList.remove('nota-errada');
                notaBox.classList.add('nota-preenchida');
                
                notaAtualIndex++;
                
                checarVitoria();

                if (notaAtualIndex < 7) {
                    atualizarFeedback(`Correto! Escolha a ${notaAtualIndex + 1}¬™ nota. Erros acumulados: ${totalErros}`);
                }

            } else {
                if (!notasComErroNesteDesafio.has(indiceNota)) {
                    totalErros++;
                    notasComErroNesteDesafio.add(indiceNota);
                }

                notaBox.classList.add('nota-errada');
                atualizarFeedback(`Ops! A nota ${notaClicada} est√° errada. Erros acumulados: ${totalErros}. Tente novamente!`, 'danger');
                
                setTimeout(() => {
                    notaBox.classList.remove('nota-errada');
                    atualizarFeedback(`Escolha a ${notaAtualIndex + 1}¬™ nota da escala. Erros acumulados: ${totalErros}`);
                }, 500);
            }
        }

        function exibirRelatorioFinal() {
            jogoFinalizado = true;
            document.getElementById('area-jogo').classList.add('d-none');
            document.getElementById('area-relatorio').classList.remove('d-none');
            
            const relatorioDiv = document.getElementById('relatorio-detalhes');
            
            const totalNotas = MAX_DESAFIOS * 6; 
            const acertosTotal = totalNotas - totalErros;
            const taxaAcerto = ((acertosTotal / totalNotas) * 100).toFixed(1);

            let mensagem = ``;
            
            if (totalErros < MAX_ERROS_PARA_REPETIR) {
                // REPETIR O DESAFIO
                mensagem = `
                    <p class="text-danger fw-bold">‚ö†Ô∏è Repeti√ß√£o Necess√°ria: Faltou Errar! ‚ö†Ô∏è</p>
                    <p>Voc√™ completou **${desafiosCompletados} desafios** com um total de **${totalErros} erros**.</p>
                    <p>O limite de erros para **PASSAR** (seguir para a pr√≥xima fase) √© de **${MAX_ERROS_PARA_REPETIR} ou mais**.</p>
                    <p>Taxa de Acerto: **${taxaAcerto}%**</p>
                    <p class="mt-4">Seu total de erros √© **menor que ${MAX_ERROS_PARA_REPETIR}**. O desafio ser√° **reiniciado** para garantir a Maestria! O objetivo √© ter **pelo menos 7 erros** para mostrar que voc√™ enfrentou a dificuldade!</p>
                `;
                
                 setTimeout(reiniciarCicloDesafios, 6000); 

            } else {
                // FINALIZA O JOGO (SUCESSO)
                mensagem = `
                    <p class="text-success fw-bold">üéâ Parab√©ns, Mestre das Escalas! üéâ</p>
                    <p>Voc√™ completou **${desafiosCompletados} desafios** com um total de **${totalErros} erros**.</p>
                    <p>Seu total de erros (${totalErros}) √© **maior ou igual ao limite de ${MAX_ERROS_PARA_REPETIR}**.</p>
                    <p>Taxa de Acerto: **${taxaAcerto}%**</p>
                    <p class="mt-4">Voc√™ superou o teste de dificuldade e pode finalizar esta etapa! Clique em "Recome√ßar o Jogo" para um novo desafio.</p>
                `;
            }
            
            relatorioDiv.innerHTML = mensagem;
        }

        function reiniciarCicloDesafios() {
            desafiosCompletados = 0;
            totalErros = 0;
            jogoFinalizado = false;
            
            document.getElementById('area-relatorio').classList.add('d-none');
            document.getElementById('area-jogo').classList.remove('d-none');
            
            gerarDesafio();
            atualizarFeedback(`Iniciando **novo ciclo de 10 desafios**! Erros zerados: ${totalErros}`);
        }

        function proximoDesafio() {
            if (desafiosCompletados < MAX_DESAFIOS) {
                gerarDesafio();
            } else {
                exibirRelatorioFinal();
            }
        }
        
        // --- Execu√ß√£o inicial ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('area-relatorio').classList.add('d-none');
        });

    </script>
</body>
</html>
