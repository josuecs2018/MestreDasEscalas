<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre das Escalas Musicais</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        /* Estilos personalizados para o jogo */
        body {
            background-color: #f8f9fa; /* Fundo mais suave */
        }

        /* Estilizando as notas do teclado */
        .nota-teclado {
            /* Usando Bootstrap para bot√µes pequenos e margens */
            width: 60px;
            height: 60px;
            margin: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
        }

        /* Estilizando o espa√ßo das notas da escala montada */
        .nota-escala {
            width: 70px;
            height: 70px;
            margin: 5px;
            border: 2px solid #343a40; /* Borda escura */
            background-color: #e9ecef; /* Cor de fundo padr√£o */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
        }

        /* Estilo para notas j√° preenchidas (cor de sucesso) */
        .nota-preenchida {
            background-color: #28a745 !important; /* Verde do Bootstrap */
            color: white;
            border-color: #1e7e34;
        }

        /* Estilo para o estado de erro */
        .nota-errada {
            animation: shake 0.5s;
            background-color: #dc3545 !important; /* Vermelho do Bootstrap */
            color: white;
        }

        /* Anima√ß√£o para feedback de erro */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    </style>
</head>
<body>

    <div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="welcomeModalLabel">Seja Bem Vindo ao jogo Mestre das Escalas üé∂</h5>
                </div>
                <div class="modal-body text-center">
                    <p class="fs-4 fw-bold text-dark">
                        Prepare seus ouvidos e sua mente! Chegou a hora de desvendar os segredos da harmonia e dominar a constru√ß√£o das escalas musicais!
                    </p>
                    <p class="text-muted">
                        Complete 10 desafios de escalas maiores para provar sua maestria. Boa sorte!
                    </p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-success btn-lg" data-bs-dismiss="modal">
                        Come√ßar a Jogar!
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Mestre das Escalas</h1>

        <div id="modo-selecao" class="text-center">
            <h3 class="mb-3">Escolha o Modo:</h3>
            <div class="d-flex justify-content-center flex-wrap">
                <button class="btn btn-primary btn-lg m-2" onclick="iniciarJogo('major')">
                    Escalas Maiores
                </button>
                
                <div class="dropdown m-2">
                    <button class="btn btn-warning btn-lg dropdown-toggle" type="button" disabled aria-expanded="false">
                        Escalas Menores (Desabilitado)
                    </button>
                </div>
            </div>
             <p class="mt-3 text-danger fw-bold">Modo de Escalas Menores desabilitado conforme as regras do desafio.</p>
        </div>
        
        <div id="area-relatorio" class="mt-5 p-4 border rounded shadow-sm d-none">
            <h2 class="text-center text-success mb-4">Relat√≥rio Final do Desafio</h2>
            <div id="relatorio-detalhes" class="fs-4 text-center"></div>
            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg" onclick="location.reload()">Recome√ßar o Jogo</button>
            </div>
        </div>

        <div id="area-jogo" class="mt-5 p-4 border rounded shadow-sm d-none">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <button class="btn btn-secondary btn-sm" onclick="location.reload()">
                    &larr; Voltar ao In√≠cio / Recome√ßar
                </button>
                <span class="badge bg-dark fs-5">Desafio <span id="contador-desafios">1</span> de 10</span>
                <h3 id="desafio-titulo" class="m-0 flex-grow-1 text-center"></h3>
            </div>
            
            <div id="escala-container" class="d-flex justify-content-center mb-4">
            </div>

            <div class="alert alert-info text-center" id="feedback-mensagem" role="alert">
                Clique nas notas abaixo para construir a escala.
            </div>

            <div id="teclado-container" class="d-flex justify-content-center flex-wrap">
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg d-none m-2" id="botao-tocar-escala" onclick="tocarEscalaCompleta()">Tocar Escala Formada üé∂</button>
                <button class="btn btn-success btn-lg d-none m-2" id="botao-proximo" onclick="proximoDesafio()">Pr√≥xima Escala</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    
    <script>
        // --- DADOS MUSICAIS CENTRAIS ---
        const notasCromaticas = [
            "C", "C#", "D", "D#", "E", "F",
            "F#", "G", "G#", "A", "A#", "B"
        ];
        
        const padraoEscala = {
            major: { 
                nome: "Maior", 
                intervalos: [0, 2, 4, 5, 7, 9, 11] 
            }
        };

        // --- VARI√ÅVEIS DE ESTADO E CONTAGEM ---
        const MAX_DESAFIOS = 10;
        const MAX_ERROS_PARA_PASSAR = 7; // Erros >= 7 = Passou / Erros < 7 = Repete
        
        let modoAtual = 'major';
        let escalaCorreta = [];
        let notaAtualIndex = 0; 
        let notasComErroNesteDesafio = new Set(); 

        let desafiosCompletados = 0;
        let totalErros = 0; // Contagem de erros √∫nicos (um erro por nota)

        let jogoFinalizado = false;

        // --- VARI√ÅVEIS DE √ÅUDIO (TONE.JS) ---
        let synth;

        function inicializarAudio() {
            if (!synth) {
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: {
                        type: "sawtooth" 
                    },
                    envelope: {
                        attack: 0.005,
                        decay: 0.1,
                        sustain: 0.3,
                        release: 1 
                    }
                }).toDestination();
                
                Tone.start();
            }
        }

        function tocarNota(nota) {
            inicializarAudio(); 
            const notaComOitava = nota + "4"; 
            synth.triggerAttackRelease(notaComOitava, "0.4s");
        }
        
        // REPRODUZ O SOM DA ESCALA FORMADA
        function tocarEscalaCompleta() {
            inicializarAudio();
            const notasComOitava = escalaCorreta.map(nota => nota + "4");
            
            notasComOitava.forEach((nota, index) => {
                Tone.Transport.scheduleOnce(time => {
                    synth.triggerAttackRelease(nota, "0.4", time);
                }, index * 0.5);
            });

            Tone.Transport.start(); 
            
            setTimeout(() => {
                Tone.Transport.stop();
            }, notasComOitava.length * 500); 
        }
        
        // --- FUN√á√ïES DE L√ìGICA MUSICAL E CONTROLE DO JOGO ---

        function gerarEscalaCorreta(tonicaIndex, modo) {
            const intervalos = padraoEscala[modo].intervalos;
            const escala = [];
            
            for (const intervalo of intervalos) {
                const indiceNota = (tonicaIndex + intervalo) % 12;
                escala.push(notasCromaticas[indiceNota]);
            }
            
            return escala;
        }

        function renderizarTeclado() {
            const tecladoDiv = document.getElementById('teclado-container');
            tecladoDiv.innerHTML = ''; 

            notasCromaticas.forEach(nota => {
                const button = document.createElement('button');
                button.className = 'btn btn-secondary nota-teclado';
                button.textContent = nota;
                button.setAttribute('onclick', `checarNota('${nota}')`);
                tecladoDiv.appendChild(button);
            });
        }

        function renderizarEscalaContainer() {
            const escalaDiv = document.getElementById('escala-container');
            escalaDiv.innerHTML = ''; 

            for (let i = 0; i < 7; i++) {
                const notaBox = document.createElement('div');
                notaBox.className = 'nota-escala';
                notaBox.id = `nota-box-${i}`;
                
                if (i === 0) {
                    notaBox.textContent = escalaCorreta[0];
                    notaBox.classList.add('nota-preenchida');
                } else {
                    notaBox.textContent = '?';
                }

                escalaDiv.appendChild(notaBox);
            }
        }

        function atualizarFeedback(mensagem, tipo = 'info') {
            const feedback = document.getElementById('feedback-mensagem');
            feedback.className = `alert alert-${tipo} text-center`;
            feedback.textContent = mensagem;
        }

        function checarVitoria() {
            if (notaAtualIndex === 7) {
                desafiosCompletados++;
                
                const modoNome = padraoEscala[modoAtual].nome;
                
                document.getElementById('contador-desafios').textContent = desafiosCompletados;
                
                atualizarFeedback(`üèÜ Desafio ${desafiosCompletados} conclu√≠do! Erros acumulados: ${totalErros}`, 'success');
                
                document.getElementById('botao-tocar-escala').classList.remove('d-none'); 
                document.querySelectorAll('.nota-teclado').forEach(btn => btn.setAttribute('disabled', 'true'));
                
                tocarEscalaCompleta(); 

                // Verifica se √© hora de terminar o ciclo
                if (desafiosCompletados >= MAX_DESAFIOS) {
                    // Espera o som da escala terminar antes de exibir o relat√≥rio
                    setTimeout(exibirRelatorioFinal, 2000); 
                } else {
                    document.getElementById('botao-proximo').classList.remove('d-none');
                }
            }
        }

        function iniciarJogo(modo) {
            // For√ßa 'major' conforme a regra
            if (modo !== 'major') return; 
            
            modoAtual = 'major';
            document.getElementById('modo-selecao').classList.add('d-none');
            document.getElementById('area-jogo').classList.remove('d-none');
            
            renderizarTeclado(); 
            gerarDesafio();
        }

        function gerarDesafio() {
            // Reseta a contagem de erros para esta escala
            notasComErroNesteDesafio.clear();
            
            const tonicaIndex = Math.floor(Math.random() * 12);
            const tonicaNome = notasCromaticas[tonicaIndex];

            escalaCorreta = gerarEscalaCorreta(tonicaIndex, modoAtual);
            notaAtualIndex = 1; 
            
            const modoNome = padraoEscala[modoAtual].nome;
            document.getElementById('desafio-titulo').textContent = `Monte a Escala de ${tonicaNome} ${modoNome}`;
            
            document.getElementById('botao-proximo').classList.add('d-none');
            document.getElementById('botao-tocar-escala').classList.add('d-none');
            
            document.querySelectorAll('.nota-teclado').forEach(btn => btn.removeAttribute('disabled'));
            
            // Atualiza o contador de desafios
            document.getElementById('contador-desafios').textContent = desafiosCompletados + 1;

            renderizarEscalaContainer();
            atualizarFeedback(`Escolha a ${notaAtualIndex + 1}¬™ nota da escala. Erros acumulados: ${totalErros}`);
        }

        function checarNota(notaClicada) {
            if (notaAtualIndex >= 7 || jogoFinalizado) return; 
            
            tocarNota(notaClicada); 

            const notaEsperada = escalaCorreta[notaAtualIndex];
            const notaBox = document.getElementById(`nota-box-${notaAtualIndex}`);
            const indiceNota = notaAtualIndex; 

            if (notaClicada === notaEsperada) {
                // ACERTOU!
                notaBox.textContent = notaClicada;
                notaBox.classList.remove('nota-errada');
                notaBox.classList.add('nota-preenchida');
                
                notaAtualIndex++;
                
                checarVitoria();

                if (notaAtualIndex < 7) {
                    atualizarFeedback(`Correto! Escolha a ${notaAtualIndex + 1}¬™ nota. Erros acumulados: ${totalErros}`);
                }

            } else {
                // ERROU!
                // Contabiliza o erro APENAS se for o primeiro erro para este √≠ndice/posi√ß√£o na escala
                if (!notasComErroNesteDesafio.has(indiceNota)) {
                    totalErros++;
                    notasComErroNesteDesafio.add(indiceNota);
                }

                notaBox.classList.add('nota-errada');
                atualizarFeedback(`Ops! A nota ${notaClicada} est√° errada. Erros acumulados: ${totalErros}. Tente novamente!`, 'danger');
                
                setTimeout(() => {
                    notaBox.classList.remove('nota-errada');
                    // Mant√©m o '?' e a mensagem de feedback
                    atualizarFeedback(`Escolha a ${notaAtualIndex + 1}¬™ nota da escala. Erros acumulados: ${totalErros}`);
                }, 500);
            }
        }

        function exibirRelatorioFinal() {
            jogoFinalizado = true;
            document.getElementById('area-jogo').classList.add('d-none');
            document.getElementById('area-relatorio').classList.remove('d-none');
            
            const relatorioDiv = document.getElementById('relatorio-detalhes');
            
            // Total de notas que deveriam ser acertadas (6 por escala * 10 desafios)
            const totalNotas = MAX_DESAFIOS * 6; 
            const acertosTotal = totalNotas - totalErros;
            const taxaAcerto = ((acertosTotal / totalNotas) * 100).toFixed(1);

            let mensagem = ``;
            
            if (totalErros < MAX_ERROS_PARA_PASSAR) {
                // REPETIR O DESAFIO (falhou em ter muitos erros)
                mensagem = `
                    <p class="text-danger fw-bold">‚ö†Ô∏è Necess√°ria Repeti√ß√£o ‚ö†Ô∏è</p>
                    <p>Voc√™ completou **10 desafios** com um total de **${totalErros} erros**.</p>
                    <p>O limite de erros para passar para a pr√≥xima etapa √© de 7 ou mais.</p>
                    <p>Taxa de Acerto: **${taxaAcerto}%**</p>
                    <p class="mt-4">Seu total de erros √© **menor que 7**. O desafio ser√° **reiniciado** para garantir a maestria na montagem das escalas!</p>
                `;
                
                 // Reinicia o jogo ap√≥s exibir a mensagem
                 setTimeout(reiniciarCicloDesafios, 6000); 

            } else {
                // FINALIZA O JOGO (SUCESSO)
                mensagem = `
                    <p class="text-success fw-bold">üéâ Parab√©ns, Mestre das Escalas! üéâ</p>
                    <p>Voc√™ completou **10 desafios** com um total de **${totalErros} erros**.</p>
                    <p>Seu total de erros (${totalErros}) √© **maior ou igual ao limite de 7** para esta fase.</p>
                    <p>Taxa de Acerto: **${taxaAcerto}%**</p>
                    <p class="mt-4">Voc√™ demonstrou maestria suficiente nesta etapa! Clique em "Recome√ßar o Jogo" para um novo desafio.</p>
                `;
                 // Remove o auto-reset, pois ele "passou"
            }
            
            relatorioDiv.innerHTML = mensagem;
        }

        function reiniciarCicloDesafios() {
            // Zera as vari√°veis de contagem
            desafiosCompletados = 0;
            totalErros = 0;
            jogoFinalizado = false;
            
            // Retorna √† √°rea de jogo
            document.getElementById('area-relatorio').classList.add('d-none');
            document.getElementById('area-jogo').classList.remove('d-none');
            
            gerarDesafio();
            atualizarFeedback(`Iniciando **novo ciclo de 10 desafios**! Erros zerados: ${totalErros}`);
        }

        function proximoDesafio() {
            if (desafiosCompletados < MAX_DESAFIOS) {
                gerarDesafio();
            } else {
                // Caso o bot√£o seja clicado antes do tempo
                exibirRelatorioFinal();
            }
        }
        
        // --- FUN√á√ÉO PARA EXIBIR A MODAL DE BEM-VINDO ---
        function showWelcomeModal() {
             const welcomeModal = new bootstrap.Modal(document.getElementById('welcomeModal'));
             welcomeModal.show();
        }

        // --- Execu√ß√£o inicial ---
        document.addEventListener('DOMContentLoaded', () => {
            // Oculta a √°rea de relat√≥rio ao carregar
            document.getElementById('area-relatorio').classList.add('d-none');
            
            // Exibe a modal de boas-vindas
            showWelcomeModal();
        });

    </script>
</body>
</html>